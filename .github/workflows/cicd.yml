  name: CI Rally Backend API

  on:
    push:
      branches: ["master"]
    workflow_dispatch:

  env:
    IMAGE_NAME: rally-backend-api
    GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
    GCP_REGION: ${{ secrets.GCP_REGION }}
    GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    SERVICE_NAME: rally-backend-api

  jobs:
    # 1️⃣ BUILD
    build:
      name: Build Go Project
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: 1.24

        - name: Cache Go modules
          uses: actions/cache@v4
          with:
            path: |
              ~/.cache/go-build
              ~/go/pkg/mod
            key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
            restore-keys: |
              ${{ runner.os }}-go-

        - name: Install swag CLI
          run: go install github.com/swaggo/swag/cmd/swag@latest

        - name: Generate Swagger docs
          run: swag init -g cmd/server/main.go -o api/docs

        # - name: Run tests (if any)
        #   run: go test ./...

        - name: Build binary
          run: |
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -v -o cmd/server/server ./cmd/server

        - name: Verify binary
          run: |
            ls -lh cmd/server/server
            file cmd/server/server

        - name: Upload build artifacts
          uses: actions/upload-artifact@v4
          with:
            name: go-binary
            path: cmd/server/server

    # 2️⃣ PUSH IMAGE
    push:
      name: Build & Push Docker Image
      runs-on: ubuntu-latest
      needs: build
      permissions:
        contents: read
        id-token: write

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Download build artifacts
          uses: actions/download-artifact@v4
          with:
            name: go-binary
            path: cmd/server
            
        - name: List files
          run: |
            echo "=== Build context contents ==="
            ls -la
            echo "=== cmd/server contents ==="
            ls -la cmd/server/

        - name: Set up Google Cloud authentication
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ env.GCP_SA_KEY }}

        - name: Configure Docker for Artifact Registry
          run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

        - name: Build Docker image
          run: |
            IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }}"
            TAG="${GITHUB_SHA::7}"
            docker build -t "$IMAGE:latest" -t "$IMAGE:$TAG" .
            echo "IMAGE_FULL=$IMAGE:$TAG" >> $GITHUB_ENV

        - name: Ensure GAR repository exists
          run: |
            gcloud artifacts repositories describe ${{ env.IMAGE_NAME }} \
              --location=${{ env.GCP_REGION }} \
              --project=${{ env.GCP_PROJECT_ID }} \
              || gcloud artifacts repositories create ${{ env.IMAGE_NAME }} \
              --repository-format=docker \
              --location=${{ env.GCP_REGION }} \
              --description="Docker repository for ${{ env.IMAGE_NAME }} images"

        - name: Push Docker image
          run: |
            docker push "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }}:latest"
            docker push "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}"

        - name: Upload image info
          run: echo "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }}" > image.txt
        - uses: actions/upload-artifact@v4
          with:
            name: image-info
            path: image.txt

    # 3️⃣ DEPLOY
    deploy:
      name: Deploy to Cloud Run
      runs-on: ubuntu-latest
      needs: push
      permissions:
        contents: read
        id-token: write

      steps:
        - name: Download image info
          uses: actions/download-artifact@v4
          with:
            name: image-info

        - name: Set up Google Cloud authentication
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ env.GCP_SA_KEY }}

        - name: Deploy to Cloud Run
          run: |
            IMAGE_FULL=$(cat image.txt)
            gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image="$IMAGE_FULL" \
              --region=${{ env.GCP_REGION }} \
              --project=${{ env.GCP_PROJECT_ID }} \
              --platform=managed \
              --allow-unauthenticated \
              --port=8080 \
              --memory=512Mi \
              --max-instances=5 \
              --set-env-vars \
                ENV=production \
              --set-secrets \
                  MONGODB_URI=MONGODB_URI:latest,\
                  MONGODB_DB=MONGODB_DB:latest,\
                  CLOUDINARY_URL=CLOUDINARY_URL:latest


    # 4️⃣ NOTIFY
    notify:
      name: Notify MS Teams
      runs-on: ubuntu-latest
      needs: [build, push, deploy]
      if: always()
      steps:
        - name: Determine Status
          id: status
          run: |
            if [[ "${{ needs.build.result }}" == "failure" || "${{ needs.push.result }}" == "failure" || "${{ needs.deploy.result }}" == "failure" ]]; then
              echo "status=Failure" >> $GITHUB_OUTPUT
              echo "color=Attention" >> $GITHUB_OUTPUT # Red
            else
              echo "status=Success" >> $GITHUB_OUTPUT
              echo "color=Good" >> $GITHUB_OUTPUT # Green
            fi

        - name: Send Notification
          run: |
            # Construct JSON Payload
            cat <<EOF > payload.json
            {
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "type": "AdaptiveCard",
                    "version": "1.2",
                    "body": [
                      {
                        "type": "TextBlock",
                        "text": "GitHub Actions Notification",
                        "weight": "Bolder",
                        "size": "Medium"
                      },
                      {
                        "type": "TextBlock",
                        "text": "Workflow: ${{ github.workflow }}",
                        "isSubtle": true,
                        "wrap": true
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          { "title": "Status:", "value": "${{ steps.status.outputs.status }}" },
                          { "title": "Repository:", "value": "${{ github.repository }}" },
                          { "title": "Branch:", "value": "${{ github.ref_name }}" },
                          { "title": "Commit:", "value": "${{ github.sha }}" }
                        ]
                      },
                      {
                        "type": "TextBlock",
                        "text": "Job Statuses:",
                        "weight": "Bolder",
                        "spacing": "Medium"
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          { "title": "Build:", "value": "${{ needs.build.result }}" },
                          { "title": "Push:", "value": "${{ needs.push.result }}" },
                          { "title": "Deploy:", "value": "${{ needs.deploy.result }}" }
                        ]
                      }
                    ],
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "View Run",
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ],
                    "msteams": {
                      "width": "Full"
                    }
                  }
                }
              ]
            }
            EOF
            
            # Send to Teams
            curl -H "Content-Type: application/json" -d @payload.json "${{ secrets.MS_TEAMS_WEBHOOK_URL }}"
